<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HG AI Agents</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --app-bg-tarot: #e8f5e9; 
            --app-bg-saju: #fffdf5; 
            --text-panda: #673ab7; 
            --text-cat: #ff5252;
            --gemini-blue: #4285f4;
        }
        body { background-color: #f0f4f9; margin: 0; overflow: hidden; font-family: 'Noto Sans KR', sans-serif; display: flex; justify-content: center; align-items: center; height: 100dvh; }
        .hidden { display: none !important; }
        
        /* ì•± ì»¨í…Œì´ë„ˆ */
        .app-container { width: 100%; max-width: 600px; height: 100dvh; display: flex; flex-direction: column; position: relative; background: #fff; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.1); }

        /* --- 1. ë¡œê·¸ì¸ í™”ë©´ (Gemini Style) --- */
        #login-screen { 
            position: absolute; inset: 0; z-index: 9999; 
            background: linear-gradient(180deg, #ffffff 0%, #f0f4f9 100%);
            display: flex; flex-direction: column; 
            padding: 20px;
        }

        .gemini-header {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            padding-bottom: 60px;
        }

        .gemini-logo {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 2.5rem;
            font-weight: 500;
            background: linear-gradient(90deg, #4285f4, #9b72cb, #d96570);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .gemini-greeting {
            font-size: 2rem;
            font-weight: 500;
            color: #c4c7c5;
            line-height: 1.3;
        }
        .gemini-greeting span {
            display: block;
            background: linear-gradient(90deg, #4b90ff, #ff5546);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .chat-input-area {
            background: #fff;
            border-radius: 30px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .chat-input-area:focus-within {
            box-shadow: 0 4px 20px rgba(66, 133, 244, 0.2);
            border-color: #4285f4;
        }
        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 1rem;
            padding: 10px;
            color: #333;
        }
        .chat-submit-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #4285f4;
            font-size: 1.2rem;
            padding: 5px;
            transition: transform 0.2s;
        }
        .chat-submit-btn:hover { transform: scale(1.1); }
        .version-tag { position: absolute; top: 20px; right: 20px; font-size: 0.75rem; color: #aaa; font-weight: bold; }


        /* --- 2. ì„ íƒ í™”ë©´ (ê¸°ì¡´ ìœ ì§€) --- */
        #selection-screen { position: absolute; inset: 0; background: #000; }
        .split-panel { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; transition: clip-path 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), filter 0.4s; cursor: pointer; overflow: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .panel-left { background: linear-gradient(135deg, #66bb6a 0%, #2e7d32 100%); clip-path: polygon(0 0, 60% 0, 40% 100%, 0 100%); z-index: 10; }
        .panel-right { background: linear-gradient(135deg, #fff8e1 0%, #ffe0b2 100%); clip-path: polygon(60% 0, 100% 0, 100% 100%, 40% 100%); z-index: 10; }
        .panel-left:hover { clip-path: polygon(0 0, 75% 0, 55% 100%, 0 100%); filter: brightness(1.1); z-index: 20; }
        .panel-right:hover { clip-path: polygon(45% 0, 100% 0, 100% 100%, 25% 100%); filter: brightness(1.05); z-index: 20; }
        
        .char-img { width: 200px; height: 200px; object-fit: contain; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3)); animation: float 3s infinite ease-in-out; transition: 0.3s; background-color: transparent; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .panel-left:hover .char-img { transform: scale(1.1) rotate(-5deg); } .panel-right:hover .char-img { transform: scale(1.1) rotate(5deg); }
        .title-badge { margin-top: 15px; padding: 8px 20px; border-radius: 12px; font-family: 'Black Han Sans', sans-serif; font-size: 2.5rem; background: rgba(255,255,255,0.95); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .panel-left .title-badge { color: var(--text-panda); border: 3px solid var(--text-panda); } .panel-right .title-badge { color: var(--text-cat); border: 3px solid var(--text-cat); }

        /* --- 3. ì•± ë‚´ë¶€ ê³µí†µ --- */
        .theme-tarot .app-container { background: var(--app-bg-tarot); } .theme-saju .app-container { background: var(--app-bg-saju); }
        #main-header { flex-shrink: 0; padding: 15px; display: flex; justify-content: space-between; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 50; transition: background 0.3s; }
        .action-btn { border-radius: 25px; padding: 12px; border: none; font-size: 1.1rem; font-family: 'Black Han Sans', sans-serif; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s; }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }
        @media (max-width: 768px) { .char-img { width: 140px; height: 140px; } .title-badge { font-size: 1.8rem; } .split-panel:hover { z-index: 10; clip-path: inherit; } .panel-left:hover { clip-path: polygon(0 0, 60% 0, 40% 100%, 0 100%); } .panel-right:hover { clip-path: polygon(60% 0, 100% 0, 100% 100%, 40% 100%); } }

        /* --- íƒ€ë¡œ ì¹´ë“œ í…Œì´ë¸” & ìŠ¤í¬ë¡¤ --- */
        #tarot-card-table { 
            display: flex; flex-wrap: wrap; justify-content: center; align-content: flex-start; 
            gap: 4px; padding: 10px; perspective: 1000px; 
            overflow-y: auto; flex: 1; width: 100%;
        }
        .tarot-card-face { 
            width: 46px; height: 72px; /* ì¹´ë“œ í¬ê¸° ë¯¸ì„¸ ì¡°ì • */
            background: radial-gradient(circle at center, #673ab7 0%, #311b92 100%); 
            border: 1px solid #b39ddb; border-radius: 4px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            font-size: 0.8rem; cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s; 
            position: relative; overflow: hidden;
        }
        .deck-waite { background: radial-gradient(circle, #7e57c2 0%, #4527a0 100%); }
        .deck-belline { background: radial-gradient(circle, #1e88e5 0%, #0d47a1 100%); border-color: #90caf9; }
        .deck-lenormand { background: radial-gradient(circle, #8d6e63 0%, #4e342e 100%); border-color: #bcaaa4; }
        .tarot-card-face::after { content: 'ğŸ‹'; opacity: 0.8; font-size: 1.2rem; }
        
        /* ì¹´ë“œ ì´ë¦„ í‘œì‹œ (ìˆ¨ê¹€ ìƒíƒœ) */
        .card-name-label {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 8px;
            text-align: center;
            padding: 2px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* ì„ íƒ ì‹œ íš¨ê³¼ */
        .card-selected { 
            background: #fff !important; /* ë’¤ì§‘íŒ íš¨ê³¼ (í°ìƒ‰ ë°°ê²½) */
            border-color: #ff6f00 !important; 
            transform: translateY(-8px) scale(1.2) rotateY(180deg) !important; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.4) !important; 
            z-index: 50; 
        }
        .card-selected::after { content: ''; } /* ë’·ë©´ ë¬´ëŠ¬ ì œê±° */
        .card-selected .card-name-label { opacity: 1; transform: rotateY(180deg); /* í…ìŠ¤íŠ¸ ë°˜ì „ ë³´ì • */ }
        .card-selected::before {
            content: 'âœ¨'; font-size: 1.5rem; transform: rotateY(180deg);
        }

        /* ì…”í”Œ ì• ë‹ˆë©”ì´ì…˜ */
        #tarot-shuffle-view { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .deck-stack { position: relative; width: 120px; height: 180px; }
        .deck-card { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #2e7d32; border: 4px solid #fff; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; font-size: 3rem; }
        .deck-card::after { content: 'ğŸ‹'; }
        .shuffling .deck-card:nth-child(1) { animation: shuffleMove 0.5s infinite alternate; }
        .shuffling .deck-card:nth-child(2) { animation: shuffleMove 0.5s infinite alternate-reverse 0.1s; }
        .shuffling .deck-card:nth-child(3) { animation: shuffleMove 0.5s infinite alternate 0.2s; }
        @keyframes shuffleMove { 0% { transform: translateX(0) rotate(0); } 25% { transform: translateX(-20px) rotate(-5deg); } 75% { transform: translateX(20px) rotate(5deg); } 100% { transform: translateX(0) rotate(0); } }

        /* Markdown Style Override */
        .markdown-body h1, .markdown-body h2 { color: #333; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .markdown-body strong { color: #d32f2f; }
        .markdown-body p { margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="app-container">

    <div id="login-screen">
        <div class="version-tag">HG Agent v1.2.0</div>
        
        <div class="gemini-header">
            <div class="gemini-logo">HG AI Agent</div>
            <div class="gemini-greeting">
                <span id="greeting-msg">ì•ˆë…•í•˜ì„¸ìš”,</span>
                ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
            </div>
        </div>

        <div class="chat-input-area">
            <input type="password" id="login-api-key" class="chat-input" placeholder="Google Gemini API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.key==='Enter') attemptLogin()">
            <button onclick="attemptLogin()" class="chat-submit-btn">â¤</button>
        </div>
        <p class="text-xs text-gray-400 text-center pb-4">ì…ë ¥í•˜ì‹  í‚¤ëŠ” ì„¸ì…˜ ë™ì•ˆë§Œ ìœ ì§€ë©ë‹ˆë‹¤.</p>
    </div>

    <div id="selection-screen" class="hidden">
        <div class="split-panel panel-left" onclick="selectMode('tarot')">
            <img id="intro-panda-img" src="./panda.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'" class="char-img">
            <div class="title-badge">íƒ€ë¡œ íŒë‹¤</div>
        </div>
        <div class="split-panel panel-right" onclick="selectMode('saju')">
            <img id="intro-cat-img" src="./cat.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'" class="char-img">
            <div class="title-badge">ë¬´ì† ëƒ¥ì´</div>
        </div>
    </div>

    <div id="main-app-ui" class="hidden h-full flex flex-col relative">
        <header id="main-header">
            <button onclick="goHome()" class="text-sm bg-white/20 px-3 py-1 rounded-full hover:bg-white/30 font-bold">â—€ ë’¤ë¡œ</button>
            <h1 id="header-title" class="font-bold text-lg font-[Do Hyeon]">ì„œë¹„ìŠ¤</h1>
            <div class="flex gap-2">
                <button onclick="openHistory()" class="text-sm bg-white/20 px-3 py-1 rounded-full" title="ê¸°ë¡ ë³´ê¸°">ğŸ“œ</button>
                <button onclick="checkAdmin()" class="text-white opacity-70 hover:opacity-100" title="ê´€ë¦¬ì ì„¤ì •">âš™ï¸</button>
            </div>
        </header>

        <div id="tarot-app" class="hidden flex-1 flex flex-col overflow-hidden relative">
            <div id="tarot-view-start" class="flex flex-col items-center justify-center text-center h-full p-4 overflow-y-auto">
                <img id="tarot-mascot" src="./panda.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'" class="w-28 h-28 rounded-full border-4 border-green-600 mb-4 bg-white object-cover shadow-lg">
                <h2 id="tarot-title" class="text-2xl font-bold text-green-900 mb-2 font-[Black Han Sans]">ë¬´ì—‡ì´ ê¶ê¸ˆí•œê°€?</h2>
                <p id="tarot-subtitle" class="text-green-700 mb-6 text-sm">ëŒ€ë‚˜ë¬´ ìˆ²ì˜ íŒë‹¤ê°€ ì¹´ë“œë¥¼ í¼ì¹©ë‹ˆë‹¤.</p>
                <input type="text" id="tarot-input" placeholder="ì˜ˆ: ì—°ì• ìš´ì´ ê¶ê¸ˆí•´!" class="w-full p-4 border-2 border-green-400 rounded-xl text-center mb-4 text-lg font-bold bg-white" onkeypress="if(event.key==='Enter') startTarotFlow()">
                <button class="action-btn bg-green-600 text-white w-full shadow-lg" onclick="startTarotFlow()">ìƒë‹´ ì‹œì‘</button>
            </div>

            <div id="tarot-shuffle-view" class="hidden h-full flex flex-col items-center justify-center">
                <div class="deck-stack shuffling mb-8">
                    <div class="deck-card"></div><div class="deck-card"></div><div class="deck-card"></div>
                </div>
                <h3 id="shuffle-text" class="text-2xl font-bold text-green-800 animate-pulse">ì¹´ë“œë¥¼ ì„ëŠ” ì¤‘...</h3>
                <p class="text-sm text-green-600 mt-2">ë§ˆìŒì„ ì°¨ë¶„íˆ í•˜ì„¸ìš”.</p>
            </div>

            <div id="tarot-view-game" class="hidden flex flex-col h-full overflow-hidden">
                <div class="bg-green-100 p-3 text-center shadow-sm z-10 flex-shrink-0">
                    <h3 id="tarot-stage-title" class="font-bold text-green-800 text-xl">ì¹´ë“œ ì„ íƒ</h3>
                    <p id="tarot-stage-desc" class="text-sm text-green-600">ì§ê´€ì ìœ¼ë¡œ ì¹´ë“œë¥¼ ê³ ë¥´ì„¸ìš”.</p>
                    <div id="tarot-selection-count" class="font-bold text-green-800 text-sm mt-1">0 / 0</div>
                </div>
                
                <div id="tarot-card-table"></div>

                <div class="p-3 bg-white border-t border-gray-200 z-10 flex-shrink-0">
                    <button id="tarot-next-btn" class="action-btn bg-green-600 text-white w-full hidden shadow-lg" onclick="confirmTarotSelection()">ë‹¤ìŒ ë‹¨ê³„</button>
                    <div id="tarot-guide-msg" class="text-center text-gray-400 text-xs font-bold py-3">ì¹´ë“œë¥¼ ëª¨ë‘ ì„ íƒí•˜ë©´ ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>

        <div id="saju-app" class="hidden flex-1 flex flex-col overflow-hidden p-4 overflow-y-auto">
            <div id="saju-view-start" class="flex flex-col items-center justify-center text-center h-full">
                <img id="saju-mascot" src="./cat.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'" class="w-28 h-28 rounded-full border-4 border-red-400 mb-4 bg-white object-cover shadow-lg">
                <h2 id="saju-title" class="text-2xl font-bold text-red-900 mb-2 font-[Black Han Sans]">ì–´ì„œ ì˜¤ë¼ëƒ¥!</h2>
                <p id="saju-subtitle" class="text-red-700 mb-6 text-sm">ìƒë…„ì›”ì¼ì„ ë‚´ë†“ì•„ë¼, ì¸„ë¥´ ì¤„ê²Œ!</p>
                <div class="w-full bg-white p-5 rounded-xl border border-red-200 space-y-3 shadow-sm">
                    <div><label class="block text-xs font-bold text-left ml-1 mb-1 text-red-800">ğŸ“… ìƒë…„ì›”ì¼</label><input type="date" id="saju-date" class="w-full p-3 border border-red-200 rounded-lg text-center font-bold text-gray-700 bg-red-50" value="2000-01-01"></div>
                    <div class="flex gap-2">
                        <div class="flex-1"><label class="block text-xs font-bold text-left ml-1 mb-1 text-red-800">â° ì‹œê°„</label><input type="time" id="saju-time" class="w-full p-3 border border-red-200 rounded-lg text-center font-bold text-gray-700 bg-red-50" value="12:00"></div>
                        <div class="flex-1"><label class="block text-xs font-bold text-left ml-1 mb-1 text-red-800">âš§ ì„±ë³„</label><select id="saju-gender" class="w-full p-3 border border-red-200 rounded-lg text-center font-bold text-gray-700 bg-red-50"><option value="male">ë‚¨ì</option><option value="female">ì—¬ì</option></select></div>
                    </div>
                    <button class="action-btn bg-red-500 text-white w-full mt-2 shadow-lg" onclick="processSajuManse()">ë§Œì„¸ë ¥ ë³´ê¸°</button>
                </div>
            </div>
            <div id="saju-view-icebreak" class="hidden h-full flex flex-col">
                <div class="bg-white p-4 rounded-xl border-2 border-red-800 mb-4 text-center">
                    <div class="text-xs bg-red-800 text-white inline-block px-3 py-1 rounded-full mb-3">íƒ€ê³ ë‚œ íŒ”ì</div>
                    <div id="saju-pillars" class="flex justify-center gap-3 mb-2"></div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-6 relative"><div class="absolute -top-3 -left-1 text-2xl">ğŸ±</div><p id="saju-persona-msg" class="text-sm pl-4 text-gray-800 font-medium leading-relaxed">ë¶„ì„ ì¤‘...</p></div>
                <div class="mt-auto"><label class="block text-center font-bold mb-2 text-red-900">ë¬´ì—‡ì´ ê¶ê¸ˆí•˜ëŠëƒëƒ¥?</label><input type="text" id="saju-input" placeholder="ì˜ˆ: ì˜¬í•´ ì¬ë¬¼ìš´ì´ ì–´ë•Œ?" class="w-full p-4 border-2 border-red-800 rounded-xl text-center mb-3 font-bold bg-white" onkeypress="if(event.key==='Enter') startSajuConsult()"><button class="action-btn bg-red-500 text-white w-full shadow-lg" onclick="startSajuConsult()">ì ê´˜ ë½‘ê¸°</button></div>
            </div>
        </div>

        <div id="common-view-loading" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center text-center p-6">
            <img id="loading-img" src="" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'" class="w-24 h-24 rounded-full mb-6 animate-bounce border-4 border-gray-300 bg-white object-cover">
            <p id="loading-text" class="text-xl font-bold text-gray-700 animate-pulse">ë¶„ì„ ì¤‘...</p>
        </div>
        <div id="common-view-result" class="hidden absolute inset-0 bg-white z-40 flex flex-col p-4 overflow-y-auto">
            <div class="text-right mb-4"><button onclick="resetCurrentMode()" class="text-sm text-gray-500 underline font-bold">ì²˜ìŒìœ¼ë¡œ</button></div>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4"><span class="font-bold text-gray-600">Q.</span> <span id="result-question" class="font-bold">ì§ˆë¬¸</span></div>
            <div class="flex-1 bg-white border-2 border-dashed border-gray-300 rounded-xl p-5 relative overflow-y-auto shadow-sm">
                <button onclick="copyResult()" class="absolute top-2 right-2 text-xs bg-gray-100 px-2 py-1 rounded border">ë³µì‚¬</button>
                <div id="result-content" class="markdown-body text-sm leading-7 text-gray-800"></div>
            </div>
            <button class="action-btn bg-gray-800 text-white w-full mt-4" onclick="resetCurrentMode()">ë‹¤ë¥¸ ì§ˆë¬¸í•˜ê¸°</button>
        </div>
        <div id="common-view-history" class="hidden absolute inset-0 bg-white z-50 flex flex-col p-4">
            <h3 class="text-center font-bold text-xl mb-4 text-gray-800">ìƒë‹´ ê¸°ë¡</h3>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-3 p-2"></div>
            <button class="w-full p-3 bg-gray-200 rounded-xl font-bold mt-4 text-gray-700" onclick="document.getElementById('common-view-history').classList.add('hidden')">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="admin-modal" class="hidden absolute inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-center font-bold text-xl mb-4 text-gray-800">ê´€ë¦¬ì ì„¤ì •</h3>
            <p id="admin-mode-label" class="text-sm text-center text-blue-600 font-bold mb-4">-</p>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-gray-500">ë©”ì¸ íƒ€ì´í‹€</label><input type="text" id="admin-title" class="w-full border p-2 rounded"></div>
                <div><label class="text-xs font-bold text-gray-500">ì„œë¸Œ íƒ€ì´í‹€</label><input type="text" id="admin-subtitle" class="w-full border p-2 rounded"></div>
                <div>
                    <label class="text-xs font-bold text-gray-500">ì•„ì´ì½˜ (ì´ë¯¸ì§€ ë³€ê²½)</label>
                    <input type="file" id="admin-file-input" accept="image/*" class="w-full text-xs mt-1" onchange="previewImage(this)">
                    <img id="admin-img-preview" class="w-16 h-16 rounded-full border mx-auto mt-2 bg-gray-100 object-cover">
                </div>
                <div class="p-3 bg-gray-100 rounded-lg border border-gray-200">
                    <label class="block text-xs font-bold text-gray-600 mb-2">AI ëª¨ë¸ ëª¨ë“œ</label>
                    <div class="flex flex-col gap-2">
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-200 p-1 rounded"><input type="radio" name="admin-model-mode" value="fast" class="w-4 h-4 text-blue-600" checked><span class="font-bold">âš¡ ë¹ ë¥¸ ì˜µì…˜ (Flash)</span></label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-200 p-1 rounded"><input type="radio" name="admin-model-mode" value="best" class="w-4 h-4 text-blue-600"><span class="font-bold">ğŸ§  ìµœìƒ ì˜µì…˜ (Pro)</span></label>
                    </div>
                </div>
            </div>
            <button onclick="saveAdmin()" class="action-btn bg-blue-600 text-white w-full mt-4 text-sm">ì €ì¥ ë° ì ìš©</button>
            <button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="w-full mt-2 text-sm text-gray-400">ë‹«ê¸°</button>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const tarotConfig = { apiKey: "AIzaSyDuQDOi5wxabpqdqu-CJfdR-krk5Q08tBA", projectId: "test-9da10", appId: "1:578765851412:web:5d9d30e09f8427d1a49001" };
    const sajuConfig = { apiKey: "AIzaSyB-y3inMOTdj48gwlh0eftUc_YfyNTeJmc", projectId: "sajutest-e4eaa", appId: "1:753725539148:web:f2d67dd6b3adf6514345e9" };
    
    let dbTarot, dbSaju;
    try {
        const appTarot = initializeApp(tarotConfig, "tarotApp");
        dbTarot = getFirestore(appTarot);
        const appSaju = initializeApp(sajuConfig, "sajuApp");
        dbSaju = getFirestore(appSaju);
    } catch(e) { console.error("Firebase Init Error:", e); }

    let currentMode = null; 
    let gameState = { stage: 0, selections: { waite: [], belline: [], lenormand: [] }, question: "" };
    let sajuState = { pillars: [], colors: [], info: {} };
    let uploadedImageBase64 = null; 
    let userApiKey = null; 
    let currentModelMode = 'fast'; 

    // --- Login ---
    window.attemptLogin = () => {
        const key = document.getElementById('login-api-key').value.trim();
        if(!key) return alert("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        userApiKey = key;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('selection-screen').classList.remove('hidden');
        // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ë‚˜ ë©”ëª¨ë¦¬ì— ì €ì¥í•˜ì—¬ ì¬ì‚¬ìš© ê°€ëŠ¥ (í˜„ì¬ëŠ” ì„¸ì…˜ ìœ ì§€)
        if(dbTarot) loadConfig('tarot', true); if(dbSaju) loadConfig('saju', true);
    };

    // --- Selection ---
    window.selectMode = (mode) => {
        currentMode = mode;
        const mainUI = document.getElementById('main-app-ui');
        const selectionScreen = document.getElementById('selection-screen');
        const header = document.getElementById('main-header');

        selectionScreen.classList.add('hidden');
        mainUI.classList.remove('hidden');
        document.body.className = ''; document.body.classList.add(`theme-${mode}`);
        header.style.background = mode === 'tarot' ? '#2e7d32' : '#c62828';

        document.getElementById('tarot-app').classList.add('hidden');
        document.getElementById('saju-app').classList.add('hidden');
        document.getElementById(`${mode}-app`).classList.remove('hidden');
        
        showView(`${mode}-view-start`);
        loadConfig(mode);
    };

    window.goHome = () => {
        currentMode = null;
        document.getElementById('main-app-ui').classList.add('hidden');
        document.getElementById('selection-screen').classList.remove('hidden');
        document.getElementById('common-view-result').classList.add('hidden');
        loadConfig('tarot', true); loadConfig('saju', true);
    };

    window.showView = (viewId) => {
        const container = document.getElementById(`${currentMode}-app`);
        const children = container.children;
        for(let c of children) c.classList.add('hidden');

        document.getElementById('common-view-result').classList.add('hidden');
        document.getElementById('common-view-loading').classList.add('hidden');
        
        const target = document.getElementById(viewId);
        if(target) target.classList.remove('hidden');
    };

    window.resetCurrentMode = () => { showView(`${currentMode}-view-start`); };

    // --- API Call ---
    async function callGemini(prompt, isJson = false) {
        if (!userApiKey) { alert("ì„¸ì…˜ ë§Œë£Œ."); location.reload(); return; }
        
        let modelName = 'gemini-2.0-flash-exp'; 
        if (currentModelMode === 'best') modelName = 'gemini-1.5-pro';

        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${userApiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: isJson ? { responseMimeType: "application/json" } : {} };
            const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text;
        } catch (e) { alert("AI ì˜¤ë¥˜: " + e.message); throw e; }
    }

    // --- Tarot Logic ---
    // ì‹¤ì œ ë± ì´ë¦„ ìƒì„± í—¬í¼
    function getCardName(deckKey, idx) {
        if(deckKey === 'waite') {
            const majors = ["The Fool", "The Magician", "The High Priestess", "The Empress", "The Emperor", "The Hierophant", "The Lovers", "The Chariot", "Strength", "The Hermit", "Wheel of Fortune", "Justice", "The Hanged Man", "Death", "Temperance", "The Devil", "The Tower", "The Star", "The Moon", "The Sun", "Judgement", "The World"];
            if(idx < 22) return majors[idx];
            
            const suits = ["Wands", "Cups", "Swords", "Pentacles"];
            const ranks = ["Ace", "2", "3", "4", "5", "6", "7", "8", "9", "10", "Page", "Knight", "Queen", "King"];
            const minorIdx = idx - 22;
            const suit = suits[Math.floor(minorIdx / 14)];
            const rank = ranks[minorIdx % 14];
            return `${rank} of ${suit}`;
        }
        else if(deckKey === 'belline') return `Belline Card #${idx + 1}`;
        else if(deckKey === 'lenormand') return `Lenormand Card #${idx + 1}`;
        return `Card #${idx + 1}`;
    }

    // ì¹´ë“œ ë± ì •ë³´: Waite 78, Belline 53, Lenormand 36
    const TAROT_STAGES = [
        { key: 'waite', name: 'ìœ ë‹ˆë²„ì…œ ì›¨ì´íŠ¸', pick: 4, color: 'deck-waite', count: 78 },
        { key: 'belline', name: 'í˜¸ë¡œìŠ¤ì½”í”„ ë²¨ë¦°', pick: 3, color: 'deck-belline', count: 53 },
        { key: 'lenormand', name: 'ë ˆë…¸ë¨¼ë“œ', pick: 3, color: 'deck-lenormand', count: 36 }
    ];

    window.startTarotFlow = () => {
        const q = document.getElementById('tarot-input').value;
        if(!q.trim()) return alert("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”!");
        gameState.question = q;
        gameState.selections = { waite: [], belline: [], lenormand: [] };
        startTarotStage(0);
    };

    function startTarotStage(idx) {
        gameState.stage = idx;
        if(idx >= TAROT_STAGES.length) { finishTarot(); return; }
        
        const config = TAROT_STAGES[idx];
        showView('tarot-shuffle-view');
        document.getElementById('shuffle-text').innerText = `${config.name} ì„ëŠ” ì¤‘...`;
        
        setTimeout(() => {
            showView('tarot-view-game');
            setupCardTable(config);
        }, 1500); 
    }

    function setupCardTable(config) {
        document.getElementById('tarot-stage-title').innerText = config.name;
        document.getElementById('tarot-stage-desc').innerText = `ì§ê´€ì ìœ¼ë¡œ ${config.pick}ì¥ì„ ì„ íƒí•˜ì„¸ìš”.`;
        document.getElementById('tarot-next-btn').classList.add('hidden');
        document.getElementById('tarot-guide-msg').classList.remove('hidden');
        updateTarotCount(0, config.pick);

        const table = document.getElementById('tarot-card-table');
        table.innerHTML = "";
        
        // --- ì§„ì§œ ì…”í”Œ ë¡œì§ ---
        const totalCards = config.count;
        let cardIndices = Array.from({length: totalCards}, (_, i) => i);
        // Fisher-Yates Shuffle
        for (let i = cardIndices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [cardIndices[i], cardIndices[j]] = [cardIndices[j], cardIndices[i]];
        }
        
        cardIndices.forEach(idx => {
            const cardName = getCardName(config.key, idx);
            const card = document.createElement('div');
            card.className = `tarot-card-face ${config.color}`;
            card.dataset.idx = idx; 
            card.dataset.name = cardName;
            
            // ì´ë¦„ ë¼ë²¨ ì¶”ê°€ (ê¸°ë³¸ì ìœ¼ë¡œëŠ” ë³´ì´ì§€ ì•ŠìŒ)
            const label = document.createElement('div');
            label.className = 'card-name-label';
            label.innerText = cardName;
            card.appendChild(label);

            card.onclick = () => toggleTarotCard(card, config.key, config.pick);
            table.appendChild(card);
        });
    }

    function toggleTarotCard(el, key, limit) {
        const list = gameState.selections[key];
        // ì¹´ë“œ ì´ë¦„: el.dataset.name ì´ìš© ê°€ëŠ¥

        if(el.classList.contains('card-selected')) {
            el.classList.remove('card-selected');
            const idx = list.indexOf(el.dataset.name); // ì´ë¦„ìœ¼ë¡œ ì €ì¥
            if(idx > -1) list.splice(idx, 1);
        } else {
            if(list.length >= limit) return alert(`ì´ ë‹¨ê³„ì—ì„œëŠ” ${limit}ì¥ê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            el.classList.add('card-selected');
            list.push(el.dataset.name); // ì´ë¦„ìœ¼ë¡œ ì €ì¥
        }
        updateTarotCount(list.length, limit);
        
        const btn = document.getElementById('tarot-next-btn');
        const guide = document.getElementById('tarot-guide-msg');
        
        if(list.length === limit) {
            btn.classList.remove('hidden');
            guide.classList.add('hidden');
        } else {
            btn.classList.add('hidden');
            guide.classList.remove('hidden');
        }
    }
    
    function updateTarotCount(c, m) { document.getElementById('tarot-selection-count').innerText = `${c} / ${m}`; }
    window.confirmTarotSelection = () => startTarotStage(gameState.stage + 1);

    async function finishTarot() {
        const mascotSrc = document.getElementById('tarot-mascot').src;
        document.getElementById('loading-img').src = mascotSrc;
        document.getElementById('loading-text').innerText = "íŒë‹¤ê°€ ëŒ€ë‚˜ë¬´ ìì„ ì½ê³  ìˆë‹¤ íŒë‹¤...";
        document.getElementById('common-view-loading').classList.remove('hidden');
        
        const now = new Date();
        const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        
        const prompt = `[í˜„ì¬ ë‚ ì§œ: ${today}] 
        ì—­í• : ëŒ€ë‚˜ë¬´ ìˆ²ì˜ í˜„ì 'íƒ€ë¡œ íŒë‹¤'.
        ì§ˆë¬¸: "${gameState.question}"
        ì„ íƒëœ ì¹´ë“œë“¤:
        - ì›¨ì´íŠ¸: ${gameState.selections.waite.join(', ')}
        - ë²¨ë¦°: ${gameState.selections.belline.join(', ')}
        - ë ˆë…¸ë¨¼ë“œ: ${gameState.selections.lenormand.join(', ')}
        
        ë§íˆ¬: "~ë‹¤ íŒë‹¤", "~í•œë‹¤ íŒë‹¤", ì¹œê·¼í•˜ê³  ì‹ ë¹„ë¡œìš´ ë§íˆ¬.
        í˜•ì‹ (Markdown):
        1. **ğŸ‹ ì„ íƒëœ ëŒ€ë‚˜ë¬´ ì (ì¹´ë“œ)**: (ì¹´ë“œ ì´ë¦„ê³¼ ì˜ë¯¸ ê°„ë‹¨ ì–¸ê¸‰)
        2. **ğŸ¼ íŒë‹¤ì˜ í•´ì„**: (ì›¨ì´íŠ¸/ë²¨ë¦°/ë ˆë…¸ë¨¼ë“œ ì¢…í•© í•´ì„)
        3. **ğŸ ëŒ€ë‚˜ë¬´ ìˆ²ì˜ ì¡°ì–¸**: (í•µì‹¬ ì¡°ì–¸)
        4. **ğŸ“ ìš”ì•½**: (ì¸ê°„ì„ ìœ„í•œ 3ì¤„ ì¡´ëŒ“ë§ ìš”ì•½)`;

        try {
            const text = await callGemini(prompt);
            displayResult(gameState.question, text);
            if(dbTarot) await addDoc(collection(dbTarot, "tarot_readings"), { question: gameState.question, response: text, timestamp: new Date() });
        } catch(e) {}
    }

    // --- Saju Logic ---
    window.processSajuManse = async () => {
        sajuState.info = { date: document.getElementById('saju-date').value, time: document.getElementById('saju-time').value, gender: document.getElementById('saju-gender').value };
        
        const mascotSrc = document.getElementById('saju-mascot').src;
        document.getElementById('loading-img').src = mascotSrc;
        document.getElementById('loading-text').innerText = "ë§Œì„¸ë ¥ì„ í¼ì¹˜ëŠ” ì¤‘...";
        document.getElementById('common-view-loading').classList.remove('hidden');
        
        try {
            const res = await callGemini(`ì—­í• :ë¬´ì†ì¸. ì •ë³´:${JSON.stringify(sajuState.info)}. JSONì¶œë ¥:{"pillars":["ì‹œ","ì¼","ì›”","ë…„"],"colors":["wood","fire","earth","metal","water"],"brief":"í•œì¤„ì„±í–¥í‰ê°€"}`, true);
            const data = JSON.parse(res);
            sajuState.pillars = data.pillars;
            
            const cont = document.getElementById('saju-pillars'); cont.innerHTML = "";
            data.pillars.forEach((p, i) => { cont.innerHTML += `<div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold ${data.colors[i] || 'earth'}">${p}</div>`; });
            
            document.getElementById('saju-persona-msg').innerText = data.brief;
            document.getElementById('common-view-loading').classList.add('hidden');
            showView('saju-view-icebreak');
        } catch(e) {
            document.getElementById('loading-text').innerText = "ì‹¤íŒ¨: " + e.message;
            setTimeout(() => document.getElementById('common-view-loading').classList.add('hidden'), 2000);
        }
    };

    window.startSajuConsult = async () => {
        const q = document.getElementById('saju-input').value;
        if(!q) return alert("ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        document.getElementById('loading-text').innerText = "ë°©ìš¸ì„ í”ë“œëŠ” ì¤‘...";
        document.getElementById('common-view-loading').classList.remove('hidden');
        
        const prompt = `ì—­í• : ì‹ í†µë°©í†µí•œ ë¬´ì†ì¸ ê³ ì–‘ì´. ì‚¬ì£¼:${sajuState.pillars}. ì§ˆë¬¸:"${q}".
        ë§íˆ¬: "~ë‹¤ëƒ¥", "~í•˜ê±°ë¼ëƒ¥". ë°˜ë§ê³¼ ì¡´ëŒ“ë§ ì„ì–´ì„œ ì¬ë¯¸ìˆê²Œ.
        í˜•ì‹ Markdown.`;

        try {
            const text = await callGemini(prompt);
            displayResult(q, text);
            if(dbSaju) await addDoc(collection(dbSaju, "saju_history"), { question: q, answer: text, date: new Date().toISOString() });
        } catch(e) {}
    };

    function displayResult(q, t) {
        document.getElementById('result-question').innerText = q;
        document.getElementById('result-content').innerHTML = marked.parse(t);
        document.getElementById('common-view-loading').classList.add('hidden');
        document.getElementById('common-view-result').classList.remove('hidden');
    }
    window.copyResult = () => navigator.clipboard.writeText(document.getElementById('result-content').innerText).then(()=>alert("ë³µì‚¬ì™„ë£Œ"));

    // --- History Logic ---
    window.openHistory = async () => {
        const listEl = document.getElementById('history-list');
        document.getElementById('common-view-history').classList.remove('hidden');
        listEl.innerHTML = "ë¡œë”© ì¤‘...";
        
        if(!dbTarot || !dbSaju) { listEl.innerHTML = "DB ì—°ê²° ì•ˆë¨"; return; }

        const db = currentMode === 'tarot' ? dbTarot : dbSaju;
        const col = currentMode === 'tarot' ? 'tarot_readings' : 'saju_history';
        const field = currentMode === 'tarot' ? 'timestamp' : 'date';

        try {
            const q = query(collection(db, col), orderBy(field, "desc"), limit(20));
            const snap = await getDocs(q);
            listEl.innerHTML = "";
            if(snap.empty) listEl.innerHTML = "ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";

            snap.forEach(d => {
                const data = d.data();
                const id = d.id;
                const div = document.createElement('div');
                div.className = "bg-gray-100 p-3 rounded flex justify-between items-center shadow-sm";
                div.innerHTML = `
                    <div class="flex-1 truncate cursor-pointer" onclick="showDetail('${id}')">
                        <div class="font-bold text-sm text-gray-800">${data.question}</div>
                        <div class="text-xs text-gray-500 truncate">${(data.response||data.answer).substring(0,30)}...</div>
                    </div>
                    <div class="flex gap-2 ml-2">
                        <button onclick="deleteHistoryItem('${id}')" class="text-lg hover:text-red-600 transition">ğŸ—‘ï¸</button>
                    </div>
                `;
                div.dataset.fullAnswer = data.response || data.answer;
                div.dataset.question = data.question;
                listEl.appendChild(div);
            });
        } catch(e) { listEl.innerHTML = "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + e.message; }
    };

    window.showDetail = (id) => {
        const listEl = document.getElementById('history-list');
        const items = listEl.children;
        for(let item of items) {
            if(item.innerHTML.includes(`deleteHistoryItem('${id}')`)) {
                displayResult(item.dataset.question, item.dataset.fullAnswer);
                document.getElementById('common-view-history').classList.add('hidden');
                return;
            }
        }
    };

    window.deleteHistoryItem = async (id) => {
        if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const db = currentMode === 'tarot' ? dbTarot : dbSaju;
        const col = currentMode === 'tarot' ? 'tarot_readings' : 'saju_history';
        try {
            await deleteDoc(doc(db, col, id));
            alert("ì‚­ì œë¨");
            openHistory();
        } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
    };

    // --- Admin Logic ---
    window.checkAdmin = () => { 
        if(currentMode && prompt("ê´€ë¦¬ì ì•”í˜¸")==="5690") {
            document.getElementById('admin-modal').classList.remove('hidden');
            document.getElementById('admin-mode-label').innerText = currentMode;
            const currentImg = document.getElementById(`${currentMode}-mascot`);
            document.getElementById('admin-img-preview').src = currentImg.src;
            const radios = document.getElementsByName('admin-model-mode');
            for(let r of radios) { r.checked = (r.value === currentModelMode); }
            uploadedImageBase64 = null;
        }
    };
    window.previewImage = (input) => { 
        if(input.files[0]) {
            const r = new FileReader(); 
            r.onload=e=>{ document.getElementById('admin-img-preview').src=e.target.result; uploadedImageBase64=e.target.result; }; 
            r.readAsDataURL(input.files[0]);
        }
    };
    window.saveAdmin = async () => {
        if(!dbTarot) return alert("DB ì—°ê²° ì‹¤íŒ¨");
        const t=document.getElementById('admin-title').value;
        const s=document.getElementById('admin-subtitle').value;
        let selectedModel = 'fast';
        const radios = document.getElementsByName('admin-model-mode');
        for(let r of radios) { if(r.checked) selectedModel = r.value; }
        const data={ modelMode: selectedModel }; 
        if(t) data.title=t; if(s) data.subtitle=s; 
        if(uploadedImageBase64) data.imgUrl=uploadedImageBase64;
        await setDoc(doc(dbTarot, "settings", "config"), data, {merge:true});
        await setDoc(doc(dbSaju, "settings", "config"), data, {merge:true});
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload();
    };

    async function loadConfig(m, h) {
        if(!dbTarot) return;
        try {
            const snap = await getDoc(doc(m==='tarot'?dbTarot:dbSaju, "settings", "config"));
            if(snap.exists()) {
                const d = snap.data();
                if(d.modelMode) currentModelMode = d.modelMode;
                if(!h) {
                    if(d.title) document.getElementById(`${m}-title`).innerText = d.title;
                    if(d.subtitle) document.getElementById(`${m}-subtitle`).innerText = d.subtitle;
                    if(d.imgUrl) document.getElementById(`${m}-mascot`).src = d.imgUrl;
                }
                if(h || !currentMode) { if(d.imgUrl) document.getElementById(m==='tarot'?'intro-panda-img':'intro-cat-img').src=d.imgUrl; }
            }
        } catch(e) {}
    }
    
    const style = document.createElement('style');
    style.innerHTML = `.wood{background:#2e7d32}.fire{background:#d32f2f}.earth{background:#fbc02d;color:#3e2723}.metal{background:#757575}.water{background:#212121}`;
    document.head.appendChild(style);

</script>
</body>
</html>
