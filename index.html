<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HG AI Agents - í•œë¯¸ê¸€ë¡œë²Œ AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --app-bg-tarot: #e8f5e9; 
            --app-bg-saju: #fffdf5; 
            --text-panda: #673ab7; 
            --text-cat: #ff5252;
        }
        body { background-color: #f0f4f9; margin: 0; overflow: hidden; font-family: 'Noto Sans KR', sans-serif; display: flex; justify-content: center; align-items: center; height: 100dvh; }
        .hidden { display: none !important; }
        
        .app-container { width: 100%; max-width: 600px; height: 100dvh; display: flex; flex-direction: column; position: relative; background: #fff; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.1); }

        /* --- ë¡œê·¸ì¸ í™”ë©´ --- */
        #login-screen { position: absolute; inset: 0; z-index: 9999; background: linear-gradient(180deg, #ffffff 0%, #f0f4f9 100%); display: flex; flex-direction: column; padding: 20px; }
        .gemini-header { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: flex-start; padding-bottom: 60px; }
        .gemini-logo { font-size: 2.5rem; font-weight: 500; background: linear-gradient(90deg, #4285f4, #9b72cb, #d96570); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        .gemini-greeting { font-size: 2rem; font-weight: 500; color: #c4c7c5; line-height: 1.3; }
        .gemini-greeting span { display: block; background: linear-gradient(90deg, #4b90ff, #ff5546); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; }
        .chat-input-area { background: #fff; border-radius: 30px; padding: 10px 20px; display: flex; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; margin-bottom: 20px; transition: all 0.3s; }
        .chat-input-area:focus-within { box-shadow: 0 4px 20px rgba(66, 133, 244, 0.2); border-color: #4285f4; }
        .chat-input { flex: 1; border: none; outline: none; font-size: 1rem; padding: 10px; color: #333; }
        .chat-submit-btn { background: none; border: none; cursor: pointer; color: #4285f4; font-size: 1.2rem; padding: 5px; }

        /* --- ì„ íƒ í™”ë©´ --- */
        #selection-screen { position: absolute; inset: 0; background: #000; display: flex; overflow: hidden; }
        .split-panel { position: relative; flex: 1; height: 100%; transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); cursor: pointer; overflow: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .panel-left { background: linear-gradient(135deg, #66bb6a 0%, #2e7d32 100%); z-index: 10; clip-path: polygon(0 0, 100% 0, 80% 100%, 0 100%); margin-right: -10%; }
        .panel-right { background: linear-gradient(135deg, #fff8e1 0%, #ffe0b2 100%); z-index: 9; clip-path: polygon(20% 0, 100% 0, 100% 100%, 0 100%); }
        .panel-left:hover, .panel-right:hover { flex: 1.5; z-index: 20; filter: brightness(1.1); }
        .panel-expanded { flex: 10 !important; clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%) !important; z-index: 50 !important; margin: 0 !important; }
        .panel-shrunk { flex: 0 !important; opacity: 0; }
        .char-img { width: 200px; height: 200px; object-fit: contain; animation: float 3s infinite ease-in-out; pointer-events: none; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .title-badge { margin-top: 15px; padding: 8px 20px; border-radius: 12px; font-family: 'Black Han Sans', sans-serif; font-size: 2.5rem; background: rgba(255,255,255,0.95); box-shadow: 0 5px 15px rgba(0,0,0,0.2); pointer-events: none; }
        .panel-left .title-badge { color: var(--text-panda); border: 3px solid var(--text-panda); } .panel-right .title-badge { color: var(--text-cat); border: 3px solid var(--text-cat); }

        /* --- ì•± ë‚´ë¶€ ê³µí†µ --- */
        .theme-tarot .app-container { background: var(--app-bg-tarot); } .theme-saju .app-container { background: var(--app-bg-saju); }
        #main-header { flex-shrink: 0; padding: 15px; display: flex; justify-content: space-between; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 50; transition: background 0.3s; }
        .action-btn { border-radius: 25px; padding: 12px; border: none; font-size: 1.1rem; font-family: 'Black Han Sans', sans-serif; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s; }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }

        /* --- íƒ€ë¡œ ì„ íƒ í…Œì´ë¸” --- */
        #tarot-card-table { display: flex; flex-wrap: wrap; justify-content: center; align-content: flex-start; gap: 4px; padding: 10px 10px 80px 10px; perspective: 1000px; overflow-y: auto; flex: 1; width: 100%; }
        .tarot-card-face { width: 46px; height: 72px; background: radial-gradient(circle at center, #673ab7 0%, #311b92 100%); border: 1px solid #b39ddb; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.8rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
        .deck-waite { background: radial-gradient(circle, #7e57c2 0%, #4527a0 100%); }
        .deck-belline { background: radial-gradient(circle, #1e88e5 0%, #0d47a1 100%); border-color: #90caf9; }
        .deck-lenormand { background: radial-gradient(circle, #8d6e63 0%, #4e342e 100%); border-color: #bcaaa4; }
        .tarot-card-face::after { content: 'ğŸ‹'; opacity: 0.8; font-size: 1.2rem; }
        .card-selected { background: #fff !important; border-color: #ff6f00 !important; transform: translateY(-8px) scale(1.2) !important; box-shadow: 0 10px 20px rgba(0,0,0,0.4) !important; z-index: 50; }
        .card-selected::after { content: 'âœ”ï¸'; }

        /* --- ì…”í”Œ --- */
        #tarot-shuffle-view { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .deck-stack { position: relative; width: 120px; height: 180px; }
        .deck-card { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #2e7d32; border: 4px solid #fff; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; font-size: 3rem; }
        .deck-card::after { content: 'ğŸ‹'; }
        .shuffling .deck-card:nth-child(1) { animation: shuffleMove 0.5s infinite alternate; }
        .shuffling .deck-card:nth-child(2) { animation: shuffleMove 0.5s infinite alternate-reverse 0.1s; }
        .shuffling .deck-card:nth-child(3) { animation: shuffleMove 0.5s infinite alternate 0.2s; }
        @keyframes shuffleMove { 0% { transform: translateX(0) rotate(0); } 25% { transform: translateX(-20px) rotate(-5deg); } 75% { transform: translateX(20px) rotate(5deg); } 100% { transform: translateX(0) rotate(0); } }

        /* --- â˜… [í•µì‹¬] ê°€ì±  ê²°ê³¼: íŒŒë€ ë°°ê²½ + ì§„ì§œ ì´ë¦„ --- */
        #gacha-modal { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .gacha-grid-433 {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 12px;
            width: 95%; max-width: 400px;
            margin-bottom: 20px;
        }

        /* ì‚¬ì¥ë‹˜ì´ ì›í•˜ì‹  ìŠ¤íƒ€ì¼: ì§„í•œ íŒŒë‘ + ë…¸ë€ í…Œë‘ë¦¬ + ëª…í™•í•œ í…ìŠ¤íŠ¸ */
        .text-card {
            aspect-ratio: 2/3;
            /* ì§„í•œ íŒŒë‘/ë³´ë¼ ê·¸ë¼ë°ì´ì…˜ */
            background: linear-gradient(135deg, #311b92 0%, #4527a0 100%);
            border: 2px solid #ffd700; /* í™©ê¸ˆ í…Œë‘ë¦¬ */
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
            padding: 5px;
            opacity: 0;
            transform: translateY(20px);
        }

        .text-card:nth-child(1), .text-card:nth-child(2), .text-card:nth-child(3), .text-card:nth-child(4) { grid-column: span 3; }
        .text-card:nth-child(5), .text-card:nth-child(6), .text-card:nth-child(7) { grid-column: span 4; }
        .text-card:nth-child(8), .text-card:nth-child(9), .text-card:nth-child(10) { grid-column: span 4; }

        .text-card.show { animation: popUp 0.5s forwards ease-out; }
        @keyframes popUp {
            0% { opacity: 0; transform: translateY(30px) scale(0.8); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .tc-deck { font-size: 0.6rem; color: #b39ddb; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
        .tc-icon { font-size: 1.8rem; margin-bottom: 5px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); }
        
        /* â˜… ì§„ì§œ ì´ë¦„ì´ ë“¤ì–´ê°ˆ ê³³ */
        .tc-name { 
            font-family: 'Black Han Sans', sans-serif; 
            font-size: 1rem; 
            color: #fff; 
            line-height: 1.1; 
            word-break: keep-all; 
            text-shadow: 0 2px 2px rgba(0,0,0,0.8);
        }

        /* Markdown Style */
        .markdown-body h1, .markdown-body h2 { color: #333; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .markdown-body strong { color: #d32f2f; }
        .markdown-body p { margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="app-container">

    <div id="gacha-modal" class="hidden">
        <h2 id="gacha-title" class="text-white text-xl font-[Black Han Sans] mb-6 text-center animate-pulse">
            <span class="text-yellow-400">âœ¨ ìš´ëª…ì˜ ì„ íƒ âœ¨</span>
        </h2>
        
        <div class="gacha-grid-433 hidden" id="gacha-reveal-area-tarot"></div>
        
        <div id="gacha-reveal-area-saju" class="hidden flex flex-col items-center justify-center">
             <div class="relative w-40 h-40 animate-spin-slow">
                <div class="absolute inset-0 border-4 border-dashed border-red-500 rounded-full animate-spin"></div>
                <div class="absolute inset-2 border-4 border-yellow-400 rounded-full animate-ping"></div>
                <img src="./cat.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'" class="absolute inset-0 w-full h-full object-cover rounded-full p-2">
             </div>
             <div id="saju-calc-msg" class="text-yellow-300 mt-8 text-xl font-bold animate-bounce">ë§Œì„¸ë ¥ ê³„ì‚° ì¤‘...</div>
        </div>

        <button id="gacha-finish-btn" class="action-btn bg-yellow-500 text-black font-bold mt-4 opacity-0 transition-opacity duration-500 px-8 shadow-xl hover:scale-105 transform">
            ğŸ”® í•´ì„ ê²°ê³¼ ë³´ê¸°
        </button>
    </div>

    <div id="login-screen">
        <div class="version-tag">HG Agent v2.5</div>
        <div class="gemini-header">
            <div class="gemini-logo">HG AI Agent</div>
            <div class="gemini-greeting">
                <span id="greeting-msg">ì•ˆë…•í•˜ì„¸ìš”,</span>
                ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
            </div>
        </div>
        <div class="chat-input-area">
            <input type="password" id="login-api-key" class="chat-input" placeholder="Google Gemini API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.key==='Enter') attemptLogin()">
            <button onclick="attemptLogin()" class="chat-submit-btn">â¤</button>
        </div>
        <p class="text-xs text-gray-400 text-center pb-4">ì…ë ¥í•˜ì‹  í‚¤ëŠ” ì„¸ì…˜ ë™ì•ˆë§Œ ìœ ì§€ë©ë‹ˆë‹¤.</p>
    </div>

    <div id="selection-screen" class="hidden">
        <div id="panel-tarot" class="split-panel panel-left" onclick="selectMode('tarot')">
            <img id="intro-panda-img" src="./panda.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'" class="char-img">
            <div class="title-badge">íƒ€ë¡œ íŒë‹¤</div>
        </div>
        <div id="panel-saju" class="split-panel panel-right" onclick="selectMode('saju')">
            <img id="intro-cat-img" src="./cat.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'" class="char-img">
            <div class="title-badge">ë¬´ì† ëƒ¥ì´</div>
        </div>
    </div>

    <div id="main-app-ui" class="hidden h-full flex flex-col relative">
        <header id="main-header">
            <button onclick="goHome()" class="text-sm bg-white/20 px-3 py-1 rounded-full hover:bg-white/30 font-bold">â—€ ë’¤ë¡œ</button>
            <h1 id="header-title" class="font-bold text-lg font-[Do Hyeon]">ì„œë¹„ìŠ¤</h1>
            <div class="flex gap-2">
                <button onclick="openHistory()" class="text-sm bg-white/20 px-3 py-1 rounded-full" title="ê¸°ë¡ ë³´ê¸°">ğŸ“œ</button>
                <button onclick="checkAdmin()" class="text-white opacity-70 hover:opacity-100" title="ê´€ë¦¬ì ì„¤ì •">âš™ï¸</button>
            </div>
        </header>

        <div id="tarot-app" class="hidden flex-1 flex flex-col overflow-hidden relative">
            <div id="tarot-view-start" class="flex flex-col items-center justify-center text-center h-full p-4 overflow-y-auto">
                <img id="tarot-mascot" src="./panda.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'" class="w-28 h-28 rounded-full border-4 border-green-600 mb-4 bg-white object-cover shadow-lg">
                <h2 id="tarot-title" class="text-2xl font-bold text-green-900 mb-2 font-[Black Han Sans]">ë¬´ì—‡ì´ ê¶ê¸ˆí•œê°€?</h2>
                <p id="tarot-subtitle" class="text-green-700 mb-6 text-sm">ëŒ€ë‚˜ë¬´ ìˆ²ì˜ íŒë‹¤ê°€ ì¹´ë“œë¥¼ í¼ì¹©ë‹ˆë‹¤.</p>
                <input type="text" id="tarot-input" placeholder="ì˜ˆ: ì´ë²ˆ í”„ë¡œì íŠ¸ ì„±ê³µí• ê¹Œ?" class="w-full p-4 border-2 border-green-400 rounded-xl text-center mb-4 text-lg font-bold bg-white" onkeypress="if(event.key==='Enter') startTarotFlow()">
                <button class="action-btn bg-green-600 text-white w-full shadow-lg" onclick="startTarotFlow()">ìƒë‹´ ì‹œì‘</button>
            </div>

            <div id="tarot-shuffle-view" class="hidden h-full flex flex-col items-center justify-center">
                <div class="deck-stack shuffling mb-8">
                    <div class="deck-card"></div><div class="deck-card"></div><div class="deck-card"></div>
                </div>
                <h3 id="shuffle-text" class="text-2xl font-bold text-green-800 animate-pulse">ì¹´ë“œë¥¼ ì„ëŠ” ì¤‘...</h3>
            </div>

            <div id="tarot-view-game" class="hidden flex flex-col h-full overflow-hidden">
                <div class="bg-green-100 p-3 text-center shadow-sm z-10 flex-shrink-0">
                    <h3 id="tarot-stage-title" class="font-bold text-green-800 text-xl">ì¹´ë“œ ì„ íƒ</h3>
                    <p id="tarot-stage-desc" class="text-sm text-green-600">ì§ê´€ì ìœ¼ë¡œ ì¹´ë“œë¥¼ ê³ ë¥´ì„¸ìš”.</p>
                    <div id="tarot-selection-count" class="font-bold text-green-800 text-sm mt-1">0 / 0</div>
                </div>
                <div id="tarot-card-table"></div>
                <div class="p-3 bg-white border-t border-gray-200 z-10 flex-shrink-0 absolute bottom-0 w-full shadow-lg">
                    <button id="tarot-next-btn" class="action-btn bg-green-600 text-white w-full hidden shadow-lg" onclick="confirmTarotSelection()">ë‹¤ìŒ ë‹¨ê³„</button>
                    <div id="tarot-guide-msg" class="text-center text-gray-400 text-xs font-bold py-3">ì¹´ë“œë¥¼ ëª¨ë‘ ì„ íƒí•˜ë©´ ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>

        <div id="saju-app" class="hidden flex-1 flex flex-col overflow-hidden p-4 overflow-y-auto">
            <div id="saju-view-start" class="flex flex-col items-center justify-center text-center h-full">
                <img id="saju-mascot" src="./cat.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'" class="w-28 h-28 rounded-full border-4 border-red-400 mb-4 bg-white object-cover shadow-lg">
                <h2 id="saju-title" class="text-2xl font-bold text-red-900 mb-2 font-[Black Han Sans]">í•œë°©ì— í•´ê²°í•œë‹¤ëƒ¥!</h2>
                <p id="saju-subtitle" class="text-red-700 mb-6 text-sm">ìƒë…„ì›”ì¼ê³¼ ê³ ë¯¼ì„ í•œ ë²ˆì— ë§í•´ë³´ë¼ëƒ¥.</p>
                <div class="w-full bg-white p-5 rounded-xl border-2 border-red-200 space-y-3 shadow-lg">
                    <div class="flex gap-2">
                        <div class="flex-1"><label class="block text-xs font-bold text-left ml-1 mb-1 text-red-800">ğŸ“… ìƒë…„ì›”ì¼</label><input type="date" id="saju-date" class="w-full p-2 border border-red-200 rounded-lg text-center font-bold text-gray-700 bg-red-50" value="2000-01-01"></div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1"><label class="block text-xs font-bold text-left ml-1 mb-1 text-red-800">â° ì‹œê°„</label><input type="time" id="saju-time" class="w-full p-2 border border-red-200 rounded-lg text-center font-bold text-gray-700 bg-red-50" value="12:00"></div>
                        <div class="flex-1"><label class="block text-xs font-bold text-left ml-1 mb-1 text-red-800">âš§ ì„±ë³„</label><select id="saju-gender" class="w-full p-2 border border-red-200 rounded-lg text-center font-bold text-gray-700 bg-red-50"><option value="male">ë‚¨ì</option><option value="female">ì—¬ì</option></select></div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-left ml-1 mb-1 text-red-800">ğŸ¤” ê³ ë¯¼ ë‚´ìš©</label>
                        <input type="text" id="saju-input" placeholder="ì˜ˆ: ì¬ë¬¼ìš´ì´ ê¶ê¸ˆí•´!" class="w-full p-3 border-2 border-red-400 rounded-lg text-center font-bold bg-white" onkeypress="if(event.key==='Enter') startSajuFlow()">
                    </div>
                    <button class="action-btn bg-red-500 text-white w-full mt-2 shadow-lg hover:bg-red-600" onclick="startSajuFlow()">ğŸ”¥ ìš´ì„¸ í™•ì¸í•˜ê¸°</button>
                </div>
            </div>
            <div id="saju-view-result-check" class="hidden h-full flex flex-col items-center justify-center">
                 <div class="bg-white p-6 rounded-2xl border-2 border-red-800 text-center shadow-xl w-full">
                    <div class="text-sm bg-red-800 text-white inline-block px-4 py-1 rounded-full mb-4">ë‹¹ì‹ ì˜ íƒ€ê³ ë‚œ íŒ”ì</div>
                    <div id="saju-pillars-result" class="flex justify-center gap-3 mb-6"></div>
                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-left">
                        <span class="text-2xl mr-2">ğŸ±</span>
                        <span id="saju-brief-msg" class="text-sm font-bold text-gray-700">ë¶„ì„ ë‚´ìš©...</span>
                    </div>
                 </div>
                 <button id="saju-final-btn" class="action-btn bg-red-600 text-white w-full mt-6 shadow-xl animate-bounce" onclick="showSajuFinalResult()">
                    ğŸ“œ AI ìƒì„¸ í’€ì´ ë°”ë¡œ ë³´ê¸°
                 </button>
                 <p class="text-xs text-gray-500 mt-2">ì´ë¯¸ ê³ ì–‘ì´ê°€ í•´ì„ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!</p>
            </div>
        </div>

        <div id="common-view-result" class="hidden absolute inset-0 bg-white z-40 flex flex-col p-4 overflow-y-auto">
            <div class="text-right mb-4"><button onclick="resetCurrentMode()" class="text-sm text-gray-500 underline font-bold">ì²˜ìŒìœ¼ë¡œ</button></div>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4"><span class="font-bold text-gray-600">Q.</span> <span id="result-question" class="font-bold">ì§ˆë¬¸</span></div>
            <div class="flex-1 bg-white border-2 border-dashed border-gray-300 rounded-xl p-5 relative overflow-y-auto shadow-sm">
                <button onclick="copyResult()" class="absolute top-2 right-2 text-xs bg-gray-100 px-2 py-1 rounded border">ë³µì‚¬</button>
                <div id="result-content" class="markdown-body text-sm leading-7 text-gray-800"></div>
            </div>
            <button class="action-btn bg-gray-800 text-white w-full mt-4" onclick="resetCurrentMode()">ë‹¤ë¥¸ ì§ˆë¬¸í•˜ê¸°</button>
        </div>

        <div id="common-view-history" class="hidden absolute inset-0 bg-white z-50 flex flex-col p-4">
            <h3 class="text-center font-bold text-xl mb-4 text-gray-800">ìƒë‹´ ê¸°ë¡</h3>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-3 p-2"></div>
            <button class="w-full p-3 bg-gray-200 rounded-xl font-bold mt-4 text-gray-700" onclick="document.getElementById('common-view-history').classList.add('hidden')">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="admin-modal" class="hidden absolute inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-center font-bold text-xl mb-4 text-gray-800">ê´€ë¦¬ì ì„¤ì •</h3>
            <p id="admin-mode-label" class="text-sm text-center text-blue-600 font-bold mb-4">-</p>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-gray-500">ë©”ì¸ íƒ€ì´í‹€</label><input type="text" id="admin-title" class="w-full border p-2 rounded"></div>
                <div><label class="text-xs font-bold text-gray-500">ì„œë¸Œ íƒ€ì´í‹€</label><input type="text" id="admin-subtitle" class="w-full border p-2 rounded"></div>
                <div>
                    <label class="text-xs font-bold text-gray-500">ì•„ì´ì½˜ (ì´ë¯¸ì§€ ë³€ê²½)</label>
                    <input type="file" id="admin-file-input" accept="image/*" class="w-full text-xs mt-1" onchange="previewImage(this)">
                    <img id="admin-img-preview" class="w-16 h-16 rounded-full border mx-auto mt-2 bg-gray-100 object-cover">
                </div>
                <div class="p-3 bg-gray-100 rounded-lg border border-gray-200">
                    <label class="block text-xs font-bold text-gray-600 mb-2">AI ëª¨ë¸ ëª¨ë“œ</label>
                    <div class="flex flex-col gap-2">
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-200 p-1 rounded"><input type="radio" name="admin-model-mode" value="fast" class="w-4 h-4 text-blue-600" checked><span class="font-bold">âš¡ ë¹ ë¥¸ ì˜µì…˜ (Flash)</span></label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-200 p-1 rounded"><input type="radio" name="admin-model-mode" value="best" class="w-4 h-4 text-blue-600"><span class="font-bold">ğŸ§  ìµœìƒ ì˜µì…˜ (Pro)</span></label>
                    </div>
                </div>
            </div>
            <button onclick="saveAdmin()" class="action-btn bg-blue-600 text-white w-full mt-4 text-sm">ì €ì¥ ë° ì ìš©</button>
            <button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="w-full mt-2 text-sm text-gray-400">ë‹«ê¸°</button>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const tarotConfig = { apiKey: "AIzaSyDuQDOi5wxabpqdqu-CJfdR-krk5Q08tBA", projectId: "test-9da10", appId: "1:578765851412:web:5d9d30e09f8427d1a49001" };
    const sajuConfig = { apiKey: "AIzaSyB-y3inMOTdj48gwlh0eftUc_YfyNTeJmc", projectId: "sajutest-e4eaa", appId: "1:753725539148:web:f2d67dd6b3adf6514345e9" };
    
    let dbTarot, dbSaju;
    try {
        const appTarot = initializeApp(tarotConfig, "tarotApp");
        dbTarot = getFirestore(appTarot);
        const appSaju = initializeApp(sajuConfig, "sajuApp");
        dbSaju = getFirestore(appSaju);
    } catch(e) { console.error("Firebase Init Error:", e); }

    let currentMode = null; 
    let gameState = { stage: 0, selections: { waite: [], belline: [], lenormand: [] }, question: "" };
    let sajuState = { pillars: [], colors: [], info: {}, question: "" };
    let uploadedImageBase64 = null; 
    let userApiKey = null; 
    let currentModelMode = 'fast'; 

    let tarotPredictionPromise = null;
    let sajuMansePromise = null;
    let sajuFinalPromise = null;

    // --- Login ---
    window.attemptLogin = () => {
        const key = document.getElementById('login-api-key').value.trim();
        if(!key) return alert("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        userApiKey = key;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('selection-screen').classList.remove('hidden');
        if(dbTarot) loadConfig('tarot', true); if(dbSaju) loadConfig('saju', true);
    };

    // --- Selection (Zoom Animation) ---
    window.selectMode = (mode) => {
        const leftPanel = document.getElementById('panel-tarot');
        const rightPanel = document.getElementById('panel-saju');
        
        if(mode === 'tarot') { leftPanel.classList.add('panel-expanded'); rightPanel.classList.add('panel-shrunk'); } 
        else { rightPanel.classList.add('panel-expanded'); leftPanel.classList.add('panel-shrunk'); }

        setTimeout(() => {
            currentMode = mode;
            document.getElementById('selection-screen').classList.add('hidden');
            document.getElementById('main-app-ui').classList.remove('hidden');
            document.body.className = ''; document.body.classList.add(`theme-${mode}`);
            document.getElementById('main-header').style.background = mode === 'tarot' ? '#2e7d32' : '#c62828';

            document.getElementById('tarot-app').classList.add('hidden');
            document.getElementById('saju-app').classList.add('hidden');
            document.getElementById(`${mode}-app`).classList.remove('hidden');
            
            showView(`${mode}-view-start`);
            loadConfig(mode);
            
            setTimeout(() => {
                leftPanel.classList.remove('panel-expanded', 'panel-shrunk');
                rightPanel.classList.remove('panel-expanded', 'panel-shrunk');
            }, 500);
        }, 600);
    };

    window.goHome = () => {
        currentMode = null;
        document.getElementById('main-app-ui').classList.add('hidden');
        document.getElementById('selection-screen').classList.remove('hidden');
        document.getElementById('common-view-result').classList.add('hidden');
        document.getElementById('gacha-modal').classList.add('hidden');
        loadConfig('tarot', true); loadConfig('saju', true);
    };

    window.showView = (viewId) => {
        const container = document.getElementById(`${currentMode}-app`);
        const children = container.children;
        for(let c of children) c.classList.add('hidden');
        document.getElementById('common-view-result').classList.add('hidden');
        const target = document.getElementById(viewId);
        if(target) target.classList.remove('hidden');
    };

    window.resetCurrentMode = () => { 
        document.getElementById('gacha-modal').classList.add('hidden');
        showView(`${currentMode}-view-start`); 
    };

    async function callGemini(prompt, isJson = false) {
        if (!userApiKey) { alert("ì„¸ì…˜ ë§Œë£Œ."); location.reload(); return; }
        let modelName = 'gemini-2.0-flash-exp'; 
        if (currentModelMode === 'best') modelName = 'gemini-1.5-pro';

        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${userApiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: isJson ? { responseMimeType: "application/json" } : {} };
            const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text;
        } catch (e) { console.error(e); throw e; }
    }

    // --- â˜… [í•µì‹¬ ìˆ˜ì •] ì‹¤ì œ ì¹´ë“œ ì´ë¦„ ë§¤í•‘ ë°ì´í„° ---
    const WAITE_MAJORS = ["The Fool", "The Magician", "The High Priestess", "The Empress", "The Emperor", "The Hierophant", "The Lovers", "The Chariot", "Strength", "The Hermit", "Wheel of Fortune", "Justice", "The Hanged Man", "Death", "Temperance", "The Devil", "The Tower", "The Star", "The Moon", "The Sun", "Judgement", "The World"];
    const WAITE_SUITS = ["Wands", "Cups", "Swords", "Pentacles"];
    const WAITE_RANKS = ["Ace", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten", "Page", "Knight", "Queen", "King"];
    
    const BELLINE_NAMES = ["Destiny", "The Star of Man", "The Star of Woman", "The Nativity", "Success", "Elevation", "Honors", "Thought", "Countryside", "Presents", "Treachery", "Departure", "Inconstancy", "Discovery", "Water", " The Penates", "Malady", "Change", "Money", "Intelligence", "Theft", "Enterprise", "Traffic", "News", "Pleasure", "Peace", "Union", "Family", "Amor", "Table", "Passions", "Wickedness", "Lawsuit", "Despotism", "Enemies", "Negotiations", "Fire", "Accident", "Support", "Beauty", "Inheritance", "Wisdom", "Fame", "Hazard", "Happiness", "Misfortune", "Sterility", "Fatalism", "Grace", "Ruins", "Delay", "Cloister", "The Blue Monkey"];

    const LENORMAND_NAMES = ["Rider", "Clover", "Ship", "House", "Tree", "Clouds", "Snake", "Coffin", "Bouquet", "Scythe", "Whip", "Birds", "Child", "Fox", "Bear", "Stars", "Stork", "Dog", "Tower", "Garden", "Mountain", "Crossroads", "Mice", "Heart", "Ring", "Book", "Letter", "Man", "Woman", "Lily", "Sun", "Moon", "Key", "Fish", "Anchor", "Cross"];

    function getCardName(deckKey, idx) {
        if(deckKey === 'waite') {
            if(idx < 22) return WAITE_MAJORS[idx];
            const minorIdx = idx - 22;
            const suit = WAITE_SUITS[Math.floor(minorIdx / 14)];
            const rank = WAITE_RANKS[minorIdx % 14];
            return `${rank} of ${suit}`;
        }
        else if(deckKey === 'belline') return BELLINE_NAMES[idx] || `Belline #${idx+1}`;
        else if(deckKey === 'lenormand') return LENORMAND_NAMES[idx] || `Lenormand #${idx+1}`;
        return `Card #${idx + 1}`;
    }

    const TAROT_STAGES = [
        { key: 'waite', name: 'ìœ ë‹ˆë²„ì…œ ì›¨ì´íŠ¸', pick: 4, color: 'deck-waite', count: 78 },
        { key: 'belline', name: 'í˜¸ë¡œìŠ¤ì½”í”„ ë²¨ë¦°', pick: 3, color: 'deck-belline', count: 53 },
        { key: 'lenormand', name: 'ë ˆë…¸ë¨¼ë“œ', pick: 3, color: 'deck-lenormand', count: 36 }
    ];

    window.startTarotFlow = () => {
        const q = document.getElementById('tarot-input').value;
        if(!q.trim()) return alert("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”!");
        gameState.question = q;
        gameState.selections = { waite: [], belline: [], lenormand: [] };
        startTarotStage(0);
    };

    function startTarotStage(idx) {
        gameState.stage = idx;
        if(idx >= TAROT_STAGES.length) { triggerTarotOptimisticProcess(); return; }
        const config = TAROT_STAGES[idx];
        showView('tarot-shuffle-view');
        document.getElementById('shuffle-text').innerText = `${config.name} ì„ëŠ” ì¤‘...`;
        setTimeout(() => { showView('tarot-view-game'); setupCardTable(config); }, 1500); 
    }

    function setupCardTable(config) {
        document.getElementById('tarot-stage-title').innerText = config.name;
        document.getElementById('tarot-stage-desc').innerText = `${config.pick}ì¥ì„ ì„ íƒí•˜ì„¸ìš”.`;
        document.getElementById('tarot-next-btn').classList.add('hidden');
        document.getElementById('tarot-guide-msg').classList.remove('hidden');
        updateTarotCount(0, config.pick);

        const table = document.getElementById('tarot-card-table');
        table.innerHTML = "";
        
        const totalCards = config.count;
        let indices = Array.from({length: totalCards}, (_, i) => i);
        for (let i = indices.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [indices[i], indices[j]] = [indices[j], indices[i]]; }
        
        indices.forEach(idx => {
            const cardName = getCardName(config.key, idx);
            const card = document.createElement('div');
            card.className = `tarot-card-face ${config.color}`;
            card.dataset.name = cardName;
            card.onclick = () => toggleTarotCard(card, config.key, config.pick);
            table.appendChild(card);
        });
    }

    function toggleTarotCard(el, key, limit) {
        const list = gameState.selections[key];
        if(el.classList.contains('card-selected')) {
            el.classList.remove('card-selected');
            const idx = list.indexOf(el.dataset.name); 
            if(idx > -1) list.splice(idx, 1);
        } else {
            if(list.length >= limit) return alert(`${limit}ì¥ê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥!`);
            el.classList.add('card-selected');
            list.push(el.dataset.name); 
        }
        updateTarotCount(list.length, limit);
        if(list.length === limit) {
            document.getElementById('tarot-next-btn').classList.remove('hidden');
            document.getElementById('tarot-guide-msg').classList.add('hidden');
        } else {
            document.getElementById('tarot-next-btn').classList.add('hidden');
            document.getElementById('tarot-guide-msg').classList.remove('hidden');
        }
    }
    
    function updateTarotCount(c, m) { document.getElementById('tarot-selection-count').innerText = `${c} / ${m}`; }
    window.confirmTarotSelection = () => startTarotStage(gameState.stage + 1);

    window.triggerTarotOptimisticProcess = () => {
        const prompt = `ì§ˆë¬¸:"${gameState.question}". ì¹´ë“œ:${JSON.stringify(gameState.selections)}. íƒ€ë¡œ ë¦¬ë”©í•´ì¤˜. í˜•ì‹: 1.ì¹´ë“œì˜ë¯¸ 2.í•´ì„ 3.ì¡°ì–¸ 4.ìš”ì•½. ë§íˆ¬: "~ë‹¤ íŒë‹¤"`;
        tarotPredictionPromise = callGemini(prompt).then(text => {
             if(dbTarot) addDoc(collection(dbTarot, "tarot_readings"), { question: gameState.question, response: text, timestamp: new Date() });
             return text;
        });
        showTarotGachaReveal();
    }

    // â˜… [í•µì‹¬] ê°€ì±  ê²°ê³¼: í…ìŠ¤íŠ¸ë¡œ ëª…í™•í•˜ê²Œ ë³´ì—¬ì£¼ê¸° (ì²«ë²ˆì§¸ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼)
    window.showTarotGachaReveal = () => {
        const modal = document.getElementById('gacha-modal');
        const grid = document.getElementById('gacha-reveal-area-tarot');
        const sajuArea = document.getElementById('gacha-reveal-area-saju');
        const btn = document.getElementById('gacha-finish-btn');
        
        grid.innerHTML = '';
        grid.className = 'gacha-grid-433';
        grid.classList.remove('hidden');
        sajuArea.classList.add('hidden');
        btn.style.opacity = '0';
        btn.onclick = finishTarotAndShow;
        modal.classList.remove('hidden');

        const allCards = [
            ...gameState.selections.waite.map(n=>({n, t:'Waite'})),
            ...gameState.selections.belline.map(n=>({n, t:'Belline'})),
            ...gameState.selections.lenormand.map(n=>({n, t:'Lenormand'}))
        ];

        allCards.forEach((card, i) => {
            const cardWrap = document.createElement('div');
            cardWrap.className = 'text-card'; // ë””ìì¸ëœ ì¹´ë“œ í´ë˜ìŠ¤
            
            // ì´ë¯¸ì§€ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼ (ë± ì¢…ë¥˜ + ì•„ì´ì½˜ + ì§„ì§œ ì´ë¦„)
            cardWrap.innerHTML = `
                <div class="tc-icon">ğŸ”®</div>
                <div class="tc-deck">${card.t}</div>
                <div class="tc-name">${card.n}</div>
            `;
            grid.appendChild(cardWrap);
            setTimeout(() => cardWrap.classList.add('show'), i * 200);
        });

        setTimeout(() => { btn.style.opacity = '1'; }, allCards.length * 200 + 300);
    }

    window.finishTarotAndShow = async () => {
        const btn = document.getElementById('gacha-finish-btn');
        btn.innerText = "í•´ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        try {
            const text = await tarotPredictionPromise; 
            document.getElementById('gacha-modal').classList.add('hidden');
            displayResult(gameState.question, text);
        } catch(e) {
            alert("AI í˜¸ì¶œ ì‹¤íŒ¨: " + e.message);
            document.getElementById('gacha-modal').classList.add('hidden');
        }
    }

    // --- Saju Logic ---
    window.startSajuFlow = async () => {
        const q = document.getElementById('saju-input').value;
        if(!q) return alert("ê³ ë¯¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        sajuState.question = q;
        sajuState.info = { date: document.getElementById('saju-date').value, time: document.getElementById('saju-time').value, gender: document.getElementById('saju-gender').value };

        showSajuGachaReveal();
        const mansePrompt = `ì—­í• :ë¬´ì†ì¸. ì •ë³´:${JSON.stringify(sajuState.info)}. JSONì¶œë ¥:{"pillars":["ì‹œ","ì¼","ì›”","ë…„"],"colors":["wood","fire","earth","metal","water"],"brief":"${q}ì— ëŒ€í•œ ì‚¬ì£¼ í•œì¤„í‰"}`;
        sajuMansePromise = callGemini(mansePrompt, true);
        sajuFinalPromise = sajuMansePromise.then(jsonStr => {
            const data = JSON.parse(jsonStr);
            sajuState.pillars = data.pillars;
            const finalPrompt = `ì‚¬ì£¼íŒ”ì:${data.pillars.join(',')}. ì§ˆë¬¸:"${q}". ìœ„ ì‚¬ì£¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¬´ì†ì¸ ê³ ì–‘ì´ ë§íˆ¬ë¡œ ìƒì„¸ ë‹µë³€í•´ì¤˜.`;
            const finalReq = callGemini(finalPrompt).then(text => {
                 if(dbSaju) addDoc(collection(dbSaju, "saju_history"), { question: q, answer: text, date: new Date().toISOString() });
                 return text;
            });
            return { manseData: data, finalReq: finalReq };
        });
    };

    async function showSajuGachaReveal() {
        const modal = document.getElementById('gacha-modal');
        const grid = document.getElementById('gacha-reveal-area-tarot');
        const sajuArea = document.getElementById('gacha-reveal-area-saju');
        const btn = document.getElementById('gacha-finish-btn');
        grid.classList.add('hidden');
        sajuArea.classList.remove('hidden');
        btn.style.opacity = '0';
        btn.onclick = null; 
        modal.classList.remove('hidden');

        try {
            await new Promise(r => setTimeout(r, 2000));
            const { manseData } = await sajuFinalPromise; 

            modal.classList.add('hidden');
            const cont = document.getElementById('saju-pillars-result'); 
            cont.innerHTML = "";
            manseData.pillars.forEach((p, i) => { 
                cont.innerHTML += `<div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold ${manseData.colors[i] || 'earth'}">${p}</div>`; 
            });
            document.getElementById('saju-brief-msg').innerText = manseData.brief;
            showView('saju-view-result-check'); 

        } catch (e) {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            modal.classList.add('hidden');
        }
    }

    window.showSajuFinalResult = async () => {
        const btn = document.getElementById('saju-final-btn');
        btn.innerText = "ê³ ì–‘ì´ê°€ ë‹µë³€ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
        try {
            const { finalReq } = await sajuFinalPromise;
            const text = await finalReq;
            displayResult(sajuState.question, text);
        } catch(e) { alert("AI ì˜¤ë¥˜"); }
    }

    function displayResult(q, t) {
        document.getElementById('result-question').innerText = q;
        document.getElementById('result-content').innerHTML = marked.parse(t);
        document.getElementById('common-view-result').classList.remove('hidden');
    }
    window.copyResult = () => navigator.clipboard.writeText(document.getElementById('result-content').innerText).then(()=>alert("ë³µì‚¬ì™„ë£Œ"));

    // --- History & Admin ---
    window.openHistory = async () => {
        const listEl = document.getElementById('history-list');
        document.getElementById('common-view-history').classList.remove('hidden');
        listEl.innerHTML = "ë¡œë”© ì¤‘...";
        if(!dbTarot) return listEl.innerHTML = "DB ë¯¸ì—°ê²°";
        const db = currentMode === 'tarot' ? dbTarot : dbSaju;
        const col = currentMode === 'tarot' ? 'tarot_readings' : 'saju_history';
        const field = currentMode === 'tarot' ? 'timestamp' : 'date';
        try {
            const q = query(collection(db, col), orderBy(field, "desc"), limit(20));
            const snap = await getDocs(q);
            listEl.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                const div = document.createElement('div');
                div.className = "bg-gray-100 p-3 rounded flex justify-between items-center shadow-sm";
                div.innerHTML = `<div class="flex-1 truncate cursor-pointer" onclick="showDetail('${d.id}', '${col}')"><div class="font-bold text-sm text-gray-800">${data.question}</div></div>`;
                div.onclick = () => displayResult(data.question, data.response || data.answer);
                listEl.appendChild(div);
            });
        } catch(e) {}
    };

    window.checkAdmin = () => { if(prompt("ê´€ë¦¬ì ì•”í˜¸")==="5690") document.getElementById('admin-modal').classList.remove('hidden'); };
    window.saveAdmin = async () => { alert("ì €ì¥ë¨(ë°ëª¨)"); document.getElementById('admin-modal').classList.add('hidden'); };
    async function loadConfig(m, h) { /* Config Loading Logic */ }

    const style = document.createElement('style');
    style.innerHTML = `.wood{background:#2e7d32}.fire{background:#d32f2f}.earth{background:#fbc02d;color:#3e2723}.metal{background:#757575}.water{background:#212121}`;
    document.head.appendChild(style);
</script>
</body>
</html>
